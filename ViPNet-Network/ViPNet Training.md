### Часть 1. Подготовка

Для начала создадим для каждой виртуальной машины свои папки, как показано ниже:

![ScreenShot](screenshots/3.png)

Далее необходимо создать и установить все виртуальные операционные системы в соответствии с таблицей ([[Reference]]):

![ScreenShot](screenshots/4.png)

После этого необходимо настроить все сетевые интерфейсы на виртуальных машинах, а также выключить встроенный Firewall. Пример с ВМ **V-1-Adm**:

![ScreenShot](screenshots/5.png)

![ScreenShot](screenshots/6.png)

![ScreenShot](screenshots/7.png)

![ScreenShot](screenshots/8.png)

Обязательно нужно проверить установились ли параметры сети:

![ScreenShot](screenshots/9.png)

Таким же образом поступаем со всеми остальными машинами на базе Windows 10. После этого, необходимо проверить доступность хостов друг для друга в рамках своих подсетей, например:

![ScreenShot](screenshots/10.png)

> Машины с идентификатором HW-VA не активны на данный момент, так как в них нет ключей, поэтому ping на них проверять не стоит. Реализация связности подсетей будет реализована позже.

Переходим на хост **V-1-DB** для того, чтобы установить SQL-сервер. Перед включением данной ВМ необходимо подключить к ней папку с компонентами ViPNet:

![ScreenShot](screenshots/11.png)

 > Для того, чтобы работала общая папка, на виртуальную машину необходимо установить пакет VMWare Tools. Вдобавок к этому, необходимо включить сетевое обнаружение.

![ScreenShot](screenshots/12.png)

![ScreenShot](screenshots/13.png)

### Часть 2. Установка SQLExpress Server

Собственно, я заранее нашел установщик **SQLEXPRESS SERVER** и извлек его из архива. Копируем установщик себе на ВМ и начинаем установку:

1. Создаем папку **C:/SQLServer** и выбираем ее в качестве директории для установки компонентов:

![ScreenShot](screenshots/14.png)

2. Выбираем "New SQL Server...":

![ScreenShot](screenshots/15.png)

3. Принимаем лицензионное соглашение:

![ScreenShot](screenshots/16.png)

4. Пропускаем пункты "Microsoft Update" и "Product Updates"
5. Выбираем устанавливаемые компоненты:

![ScreenShot](screenshots/17.png)

6. Конфигурирование состояния сервера:

![ScreenShot](screenshots/18.png)

7. Конфигурация сервера:

![ScreenShot](screenshots/19.png)

8. Конфигурация ядра БД (**пароль - 1234**):

![ScreenShot](screenshots/20.png)

![ScreenShot](screenshots/21.png)

Далее происходит процесс установки. При успешном завершении инсталляции ошибок возникнуть не должно:

![ScreenShot](screenshots/22.png)

После успешной установки необходимо активировать **протокол TCP/IP** на SQL-сервере:

![ScreenShot](screenshots/23.png)

Перезапускаем SQL-сервер, чтобы изменения вступили в силу:

![ScreenShot](screenshots/24.png)

>  Точно такую же операцию необходимо повторить на хосте **V-3-Open**!

На этом установка и настройка SQLExpress-сервера завершена.

### Часть 3. Установка ЦУС на Adm

#### 3.1. Установка серверной части ЦУС

![ScreenShot](screenshots/25.png)

Подключаемся к базе данных, которую мы создали на прошлом этапе, но не путайте подсети - для каждой из них своя БД! Далее представлена установка ЦУС на ВМ V-1-Adm:

![ScreenShot](screenshots/26.png)

Обязательно стоит проверять подключение к БД, иначе далее продолжить настройку ViPNet будет невозможно.

> Логин: sa; Пароль: 1234

![ScreenShot](screenshots/27.png)

Тот же самый процесс проделываем для ВМ V-3-Adm, только не забываем поменять IP-адрес SQL-сервера.
#### 3.2. Установка клиентской части ЦУС

![ScreenShot](screenshots/28.png)

![ScreenShot](screenshots/29.png)

Дожидаемся процесса установки и приступаем к УКЦ

![ScreenShot](screenshots/30.png)

> Тот же самый процесс проделываем для ВМ V-3-Adm
### Часть 4. Установка УКЦ на Adm

![ScreenShot](screenshots/31.png)

![ScreenShot](screenshots/32.png)

Точно также, как и с ЦУС, устанавливаем УКЦ, как для **V-1-Adm**, так и для **V-3-Adm**

![ScreenShot](screenshots/33.png)

### Часть 5. Установка лицензии на ЦУС

Запускаем ЦУС на **V-1-Adm**. При первоначальной авторизации вводим **Administrator:Administrator**:

![ScreenShot](screenshots/34.png)

Далее нам сразу предлагают сменить пароль:

![ScreenShot](screenshots/35.png)

После этого необходимо установить лицензию:

![ScreenShot](screenshots/36.png)

![ScreenShot](screenshots/37.png)

После принятия лицензии нам предлагается выбрать вариант начала работы. Это окно можно просто закрыть

![ScreenShot](screenshots/38.png)

Все операции необходимо повторить для V-3-Adm

> КРАЙНЕ ВАЖНО: обратите внимание на лицензии, их в нашем случае 2, ни в коем случае не применяйте одинаковые лицензии на несколько подсетей (ViPNet администраторов), иначе в дальнейшем невозможно будет настроить межсетевое взаимодействие между подсетями. Поэтому, на V-3-Adm активируем другую лицензию!

### Часть 6. Создание координаторов и клиентов, присвоение связей и ролей

В ЦУС на **V-1-Adm** создаем два координатора - **Coordinator 1** и **Coordinator HW-VA**:

![ScreenShot](screenshots/39.png)

![ScreenShot](screenshots/40.png)

Далее создаем клиентов - **Admin 1**, **Client 2**, **OperCA**:

![ScreenShot](screenshots/41.png)

![ScreenShot](screenshots/42.png)

> Обратите внимание на то, каким пользователям, какие координаторы присвоены

По итогу имеем 5 пользователей (они создаются автоматически по мере создания клиентов и координаторов):

![ScreenShot](screenshots/43.png)

Далее создаем связи (все-ко-всем):

![ScreenShot](screenshots/44.png)

![ScreenShot](screenshots/45.png)

![ScreenShot](screenshots/46.png)

Данный алгоритм нужно проделать для всех пользователей. Выбор связей для каждого последующего пользователя будет сокращаться, поэтому у последнего из них вариантов не будет, т.к. все связи будут уже созданы.

Далее создаем межсерверный канал. Переходим на **Coordinator 1**:

![ScreenShot](screenshots/47.png)

![ScreenShot](screenshots/48.png)

> Межсерверный канал создается только для подсетей, где расположены V-1-Coord и V-2-HW-VA, подсеть V-3 это не касается

### Часть 7. Создание ключей через УКЦ

Теперь выделяем все координаторы и создаем справочники (тоже самое делаем для "клиентов"):

![ScreenShot](screenshots/49.png)

![ScreenShot](screenshots/50.png)

![ScreenShot](screenshots/51.png)

ЦУС указывает на то, что ожидаются ключи, поэтому запускаем УКЦ (**V-1-Adm**):

![ScreenShot](screenshots/52.png)

![ScreenShot](screenshots/53.png)

Производим первичную инициализацию:

![ScreenShot](screenshots/54.png)

![ScreenShot](screenshots/55.png)

> Имя и пароль не меняем

![ScreenShot](screenshots/56.png)

Далее следуют "**Сведения о владельце сертификата**", которые можно пропустить

![ScreenShot](screenshots/57.png)

Параметры ключа ЭЦП не изменяем

![ScreenShot](screenshots/58.png)

![ScreenShot](screenshots/59.png)

Разделы "**Сведения о точках распространения**" и "**Программные средства**" пропускаем, не меняя параметров

![ScreenShot](screenshots/60.png)

![ScreenShot](screenshots/61.png)

![ScreenShot](screenshots/62.png)

Завершение первичной инициализации УКЦ:

![ScreenShot](screenshots/63.png)

![ScreenShot](screenshots/64.png)

Далее создадим дистрибутив ключей:

![ScreenShot](screenshots/65.png)

Переходим в раздел "**Сетевые узлы**" и запускаем выдачу дистрибутива ключей:

![ScreenShot](screenshots/66.png)

![ScreenShot](screenshots/67.png)

Шифрование не меняем

![ScreenShot](screenshots/68.png)

Раздел "**Назначение сертификата**" пропускаем. Создаем пароль для пользователя **Admin 1** (т.к. он самый первый на выдаче):

![ScreenShot](screenshots/69.png)

"**Сведения о владельце сертификата**" пропускаем. Данные шаги необходимо проделать и для остальных пользователей. В случае, если вы выделили всех пользователей сразу, то процесс настройки не будет прерываться - вы сразу настраиваете всех пользователей.

> В случае, если дистрибутив ключей вы сделали неправильно по какой-либо причине, то стоит снова создать справочники в ЦУС, перейти после этого в УКЦ, выделить пользователей и "Выдать новый дистрибутив ключей"

Когда ключи будут сформированы, откроется директория с папками, где находятся ключи:

![ScreenShot](screenshots/70.png)

Для удобства перемещаем ключи в общую папку, которую мы подключали к ВМ.

### Часть 8. Применение ключей на хостах

На машину **V-1-Cord** необходимо установить ПО координатора (Архив Coordinator for Windows):

![ScreenShot](screenshots/71.png)

После установки заходим в саму программу:

![ScreenShot](screenshots/72.png)

При первом запуске должен появиться запрос ключа. Устанавливаем его:

![ScreenShot](screenshots/73.png)

> Именно для этого мы переносили в общую папку ключи, чтобы удобно их вытащить при необходимости

![ScreenShot](screenshots/74.png)

Проходим авторизацию при запуске ПО ViPNet Coordinator:

![ScreenShot](screenshots/75.png)

После аутентификации приложение открывается в фоновом режиме, открываем его. Возможно, нужно немного подождать, пока у нас не спросят разрешения на работу с сетью:

![ScreenShot](screenshots/76.png)

Далее нам необходимо установить ПО **ViPNet Client** на **V-1-OperCA**, **V-1-Adm** и **V-2-Cli**. Сама установка не требует специфических операций - нужно просто запустить установщик. После этого запускаем установленное ПО на виртуальных машинах и применяем созданные ранее ключи. Итог:

V-1-Adm:

![ScreenShot](screenshots/77.png)

V-1-Coord:

![ScreenShot](screenshots/78.png)

V-2-Cli:

![ScreenShot](screenshots/79.png)

> Можно заметить, что, например, V-2-Cli не видит другие узлы сети. Это объясняется на данный момент тем, что наши два координатора Coordinator 1 и Coordinator 2 HW-VA не соединены между собой. С другой стороны, все хосты, которые относятся непосредственно к Coordinator 1 видят друг друга, как и должно быть

### Часть 9. Настройка связности координаторов

Для начала необходимо координатору "**Coordiantor 2 HW-VA**" выдать роль "**Coordiantor HW-VA**" и удалить остальные роли. Данные операции проделываются через ЦУС на V-1-Adm:

![ScreenShot](screenshots/80.png)

![ScreenShot](screenshots/81.png)

Далее вновь для координаторов и клиентов создаем справочники (ЦУС):

![ScreenShot](screenshots/82.png)

![ScreenShot](screenshots/83.png)

Теперь в УКЦ выдаем новый дистрибутив ключей и передаем их в ЦУС (процесс выдачи нового дистрибутива ключей представлен выше):

![ScreenShot](screenshots/84.png)

![ScreenShot](screenshots/85.png)

Далее уже через ЦУС отправляем справочники и ключи:

![ScreenShot](screenshots/86.png)

![ScreenShot](screenshots/87.png)

После этого занимаемся установкой ключа на **Coordiantor 2 HW-VA**. Для этого нам необходима утилита, которая способна создавать iso-образы. Я использую **ImgBurn**. При помощи данной утилиты необходимо конечную папку с ключом от **Coordiantor 2 HW-VA** переделать в iso-образ, который впоследствии мы будем монтировать к виртуальной машине:

![ScreenShot](screenshots/88.png)

![ScreenShot](screenshots/89.png)

Подключаем диск к ВМ **V-2-HW-VA**:

![ScreenShot](screenshots/90.png)

Запускаем второй координатор:

![ScreenShot](screenshots/91.png)

> Первоначально, логин и пароль - user, после установки ключа данные для входа изменяется на - user:xxXX2233

![ScreenShot](screenshots/92.png)

![ScreenShot](screenshots/93.png)

![ScreenShot](screenshots/94.png)

Далее следует проверка пароля - xxXX2233 - после чего настраиваем сетевые интерфейсы:

![ScreenShot](screenshots/95.png)

![ScreenShot](screenshots/96.png)

![ScreenShot](screenshots/97.png)

![ScreenShot](screenshots/98.png)

![ScreenShot](screenshots/99.png)

Службы DNS и NTP в данный момент не настраиваем. Диапазон виртуальных IP-адресов оставляем по умолчанию. После этого нам предлагают проверить связь между координаторами:

![ScreenShot](screenshots/100.png)

Выбираем "Yes" и далее выбираем значение параметра "firewall mode". Необходимо выбрать "**No External Firewall**":

![ScreenShot](screenshots/101.png)

![ScreenShot](screenshots/102.png)

Далее необходимо выбрать сетевой интерфейс, который будет установлен в качестве внешнего, т.е. смотреть в сторону другого координатора:

![ScreenShot](screenshots/103.png)

Вот и найденный соседний координатор (V-1-Coord):

![ScreenShot](screenshots/104.png)

![ScreenShot](screenshots/105.png)

![ScreenShot](screenshots/106.png)

![ScreenShot](screenshots/107.png)

![ScreenShot](screenshots/108.png)

В итоге мы должны получить сообщение "**VPN probing has succeeded**". Заканчиваем конфигурирование координатора:

![ScreenShot](screenshots/109.png)

![ScreenShot](screenshots/110.png)

Если перейти на машину V-1-Coord и посмотреть компоненты сети, то можем обнаружить, что у нас все хосты определились:

![ScreenShot](screenshots/111.png)

Перед тем, как продолжить работу непосредственно с машинами V-3-XXX, посмотрим, что мы имеем на данный момент:
1. Установленный SQL-сервер на V-3-Open;
2. Установленные ЦУС и УКЦ на V-3-Adm;
3. Активация Лицензии в ЦУС на V-3-Adm;
4. Созданный координатор "**Coordiantor 3 HW-VA**", которому присвоена **роль** "**Coordinator HW-VA**" (+ удалены остальные) в ЦУС на V-3-Adm;
5. Созданный клиент "**Admin 3**" (при его создании указывается **Coordiantor 3 HW-VA**) в ЦУС на V-3-Adm (**НЕ СОЗДАЕМ КЛИЕНТА ДЛЯ МАШИНЫ V-3-Open**);
6. Созданы справочники и ключи, при этом инициализирован УКЦ на V-3-Adm;
7. Выдан новый дистрибутив ключей для каждого пользователя/координатора через УКЦ на V-3-Adm;
8. Установлено ПО ViPNet Client на V-3-Adm (+активация);
9. Активирован координатор "**Coordiantor 3 HW-VA**" (тут **не нужно проверять соединение** между этим координатором и другими из первой и второй подсетей, просто завершаем настройку, но в качестве **основного шлюза** указываем **IP-адрес Coordiantor 1**);
10. Повторно **создаем справочники** в ЦУС на **V-3-Adm**, затем через УКЦ **создаем и передаем ключи в ЦУС**, после этого уже в ЦУС **отправляем справочники и ключи**.
